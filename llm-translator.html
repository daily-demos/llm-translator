<html>
  <head>
    <title>Daily.co Translator Demo</title>
    <script src="https://unpkg.com/@daily-co/daily-js"></script>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, avenir next, avenir,
          segoe ui, helvetica neue, helvetica, Cantarell, Ubuntu, roboto, noto,
          arial, sans-serif;
        font-size: 1.6em;
      }
      button {
        font-size: 1em;
      }
      select {
        font-size: 1em;
      }
      div#controls-left select {
        font-size: 0.6em;
      }

      div#videos {
        display: flex;
        width: 100%;
        max-width: 100%;
        height: 90%;
        display: flex;
      }
      div#videos > div {
        padding: 1em;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
      }
      div#videos > div video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      div#videos .subtitles {
        height: 5em;
      }
      div#videos .subtitles p {
        text-align: center;
        margin-block-start: 0.2em;
      }
      div#controls {
        padding: 0.2em;
        display: flex;
        justify-content: space-between;
      }
    </style>
  </head>
  <body onload="main()">
    <div id="controls">
      <div id="controls-left">
        <button id="load-devices" onclick="loadDevices()" style="display: none">
          Load Cameras
        </button>
        <select id="cams" style="display: none"></select>
        <select id="mics" style="display: none"></select>
        <button id="join" onclick="joinRoom()">Join Room</button>
        <button id="leave" onclick="leaveRoom()">Leave Room</button>
      </div>
      <div id="controls-right">
        <span>Language:</span>
        <select id="language" onChange="changeLanguage()">
          <option value="english" selected>English</option>
        </select>
      </div>
    </div>
    <div id="videos"></div>
    <div id="audios"></div>
    <script>
      const urlParams = new URLSearchParams(window.location.search);

      const languageSelect = document.getElementById("language");
      const loadButton = document.querySelector("button#load-devices");
      const camSelect = document.querySelector("select#cams");
      const micSelect = document.querySelector("select#mics");
      const host = !!urlParams.get("host");

      function cap(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
      }

      function isTranslator(p) {
        return p.user_name.match(/^tb\-.*/);
      }

      function translatorLanguage(p) {
        return p.user_name.match(/^tb\-(.*)/)[1];
      }

      function showSubtitle(paxId, message) {
        const subtitleDiv = document.getElementById("subtitles-" + paxId);
        const p = document.createElement("p");
        p.innerHTML = message;
        subtitleDiv.appendChild(p);
        setTimeout(() => {
          p.remove();
        }, 7000);
      }

      async function main() {
        if (host) {
          loadButton.style.display = "inline";
          camSelect.style.display = "inline";
          micSelect.style.display = "inline";
        }
      }

      function startTrack(evt) {
        if (evt.track.kind === "audio" && !evt.participant.local) {
          let audiosDiv = document.getElementById("audios");
          let audioEl = document.createElement("audio");
          audiosDiv.appendChild(audioEl);
          audioEl.style.width = "100%";
          audioEl.srcObject = new MediaStream([evt.track]);
          audioEl.play();
        } else if (evt.track.kind === "video") {
          let pid = evt.participant.session_id;
          let videosDiv = document.getElementById("videos");
          let paxDiv = document.createElement("div");
          paxDiv.id = "pax-" + pid;
          let videoEl = document.createElement("video");
          let subtitleDiv = document.createElement("div");
          subtitleDiv.classList.add("subtitles");
          subtitleDiv.id = "subtitles-" + pid;
          paxDiv.appendChild(videoEl);
          paxDiv.appendChild(subtitleDiv);
          videosDiv.appendChild(paxDiv);
          videoEl.srcObject = new MediaStream([evt.track]);
          videoEl.play();
        }
      }

      function stopTrack(evt) {
        let vids = document.getElementsByTagName("video");
        for (let vid of vids) {
          if (
            vid.srcObject &&
            vid.srcObject.getVideoTracks()[0] === evt.track
          ) {
            vid.remove();
          }
        }
      }

      async function changeLanguage() {
        const lang = languageSelect.value;
        console.log("changing language to: ", lang);
        let allPax = call.participants();
        let paxIds = Object.keys(allPax).filter((p) => p !== "local");
        paxIds.forEach((id) => {
          const p = allPax[id];
          const wantsAudio =
            (isTranslator(p) && translatorLanguage(p) === lang) ||
            (!isTranslator(p) && lang === "english");
          call.updateParticipant(id, {
            setSubscribedTracks: { audio: wantsAudio },
          });
        });
      }

      async function joinRoom() {
        const domain = urlParams.get("domain") || "YOURDOMAIN";
        const room = urlParams.get("room") || "YOURROOM";

        const ROOM_URL = `https://${domain}.daily.co/${room}`;
        window.call = DailyIframe.createCallObject({
          url: ROOM_URL,
          subscribeToTracksAutomatically: false,
          audioSource: host ? micSelect.value : false,
          videoSource: host ? camSelect.value : false,
          dailyConfig: {},
        });

        [
          "participant-updated",
          "participant-left",
          "participant-joined",
          "error",
          "camera-error",
          "started-camera",
          "active-speaker-change",
          "recording-started",
          "recording-stopped",
          "recording-error",
          "track-started",
          "track-stopped",
        ].forEach((e) => {
          call.on(e, (ev) => {
            console.log(`ðŸ”¥ ${e}:`, ev);
          });
        });

        call.on("track-started", startTrack);
        call.on("track-stopped", stopTrack);

        call.on("participant-joined", (ev) => {
          const p = ev.participant;
          // is this a person or a translator bot?

          if (isTranslator(p)) {
            // This is a translator. Update the list of languages
            // to include this translator's language
            const lang = translatorLanguage(p);
            const newOpt = document.createElement("option");
            newOpt.value = lang;
            newOpt.text = cap(lang);
            languageSelect.appendChild(newOpt);
          } else {
            // This is a human. Subscribe to their video, and their
            // audio if the current language is English
            const audioSub = languageSelect.value === "english";
            call.updateParticipant(p["session_id"], {
              setSubscribedTracks: {
                video: true,
                audio: audioSub,
              },
            });
          }
        });

        call.on("app-message", (e) => {
          const lang = languageSelect.value;
          if (e.fromId === "transcription" && lang === "english") {
            showSubtitle(e.data.session_id, e.data.text);
          } else if (e.data.translation_language === lang) {
            showSubtitle(e.data.session_id, e.data.translation);
          }
          e.fromId;
        });
        await call.join({});
      }

      async function leaveRoom() {
        let vids = document.getElementsByTagName("video");
        for (let vid of vids) {
          vid.remove();
        }
        await call.leave();
      }
      async function loadDevices() {
        const dummy = await navigator.mediaDevices.getUserMedia({
          audio: true,
          video: true,
        });
        let dummyTracks = dummy.getTracks();
        for (t in dummyTracks) {
          dummyTracks[t].stop();
        }

        var devices = await navigator.mediaDevices.enumerateDevices();
        var cameras = devices.filter((d) => d.kind == "videoinput");
        var mics = devices.filter((d) => d.kind == "audioinput");
        for (var c of cameras) {
          var opt = document.createElement("option");
          opt.value = c.deviceId;
          opt.text = c.label;
          camSelect.appendChild(opt);
        }
        for (var m of mics) {
          var opt = document.createElement("option");
          opt.value = m.deviceId;
          opt.text = m.label;
          micSelect.appendChild(opt);
        }

        // go ahead and start showing the first camera in the list
        //previewCam();
      }
    </script>
  </body>
</html>
